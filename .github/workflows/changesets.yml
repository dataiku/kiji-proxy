name: Changesets Release

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Create Release PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            src/frontend/package-lock.json

      - name: Check for changesets
        id: check_changesets
        run: |
          if ls .changeset/*.md 1> /dev/null 2>&1; then
            # Exclude README.md from the count
            count=$(ls .changeset/*.md 2>/dev/null | grep -v "README.md" | wc -l)
            if [ "$count" -gt 0 ]; then
              echo "has_changesets=true" >> $GITHUB_OUTPUT
              echo "Found $count changeset(s)"
            else
              echo "has_changesets=false" >> $GITHUB_OUTPUT
              echo "No changesets found (only README.md exists)"
            fi
          else
            echo "has_changesets=false" >> $GITHUB_OUTPUT
            echo "No changesets found"
          fi

      - name: Install Dependencies
        if: steps.check_changesets.outputs.has_changesets == 'true'
        run: |
          # Install root dependencies (includes @changesets/cli)
          npm install

          # Install workspace dependencies
          npm install --workspace=src/frontend

      - name: Create Version PR
        if: steps.check_changesets.outputs.has_changesets == 'true'
        id: changesets
        run: |
          # Run changeset version from root (where .changeset folder is)
          # It will update src/frontend/package.json based on workspace config
          npx changeset version

          # Check if there are changes
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes were made by changesets"
          fi

      - name: Create Pull Request
        if: steps.changesets.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "chore: version packages"
          title: "chore: version packages"
          body: |
            This PR was automatically generated by the Changesets workflow.

            Merging this PR will:
            - Update package version in `src/frontend/package.json`
            - Update `CHANGELOG.md` with the changes
            - Trigger the release workflow to build a DMG

            After merging, create a git tag to publish the release:
            ```bash
            git tag -a vX.Y.Z -m "Release X.Y.Z"
            git push origin vX.Y.Z
            ```
          branch: changeset-release/main
          delete-branch: true
          labels: release

      - name: No changesets found
        if: steps.check_changesets.outputs.has_changesets != 'true'
        run: |
          echo "âœ… No changesets found - skipping version PR creation"
          echo "This is normal if no changes requiring a release were made."

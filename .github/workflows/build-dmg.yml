name: Build DMG

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

jobs:
  build-dmg:
    runs-on: macos-latest
    name: Build DMG for macOS
    permissions:
      contents: write  # Required to create releases

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Install Python dependencies
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install onnxruntime

    - name: Find and copy ONNX Runtime library
      run: |
        source .venv/bin/activate
        ONNX_LIB=$(find .venv -name "libonnxruntime*.dylib" | head -1)
        if [ -n "$ONNX_LIB" ]; then
          cp "$ONNX_LIB" ./build/libonnxruntime.1.23.1.dylib
          echo "âœ… ONNX Runtime library copied"
        else
          echo "âš ï¸  ONNX Runtime library not found, continuing..."
        fi

    - name: Build tokenizers library (if needed)
      run: |
        cd tokenizers
        if [ -f "libtokenizers.a" ]; then
          echo "âœ… Using existing libtokenizers.a"
        elif [ -f "libtokenizers.darwin-arm64.tar.gz" ]; then
          echo "Extracting pre-built library..."
          tar -xzf libtokenizers.darwin-arm64.tar.gz
        elif [ -f "Makefile" ]; then
          echo "Building with Makefile..."
          make build || cargo build --release
          if [ -f "target/release/libtokenizers.a" ]; then
            cp target/release/libtokenizers.a ./libtokenizers.a
          fi
        else
          echo "Building with cargo..."
          cargo build --release
          if [ -f "target/release/libtokenizers.a" ]; then
            cp target/release/libtokenizers.a ./libtokenizers.a
          fi
        fi
        if [ ! -f "libtokenizers.a" ]; then
          echo "âŒ Failed to obtain libtokenizers.a"
          exit 1
        fi
        cd ..

    - name: Install Electron dependencies
      working-directory: frontend
      run: npm ci

    - name: Build Electron app
      working-directory: frontend
      run: npm run build:electron

    - name: Build Go binary
      run: |
        mkdir -p build
        CGO_ENABLED=1 \
        go build \
          -tags embed \
          -ldflags="-extldflags '-L./tokenizers'" \
          -o build/yaak-proxy \
          ./src/backend

    - name: Prepare Electron resources
      run: |
        mkdir -p frontend/resources
        cp build/yaak-proxy frontend/resources/yaak-proxy
        chmod +x frontend/resources/yaak-proxy

        # Copy ONNX library if it exists
        if [ -f "libonnxruntime.1.23.1.dylib" ]; then
          cp build/libonnxruntime.1.23.1.dylib frontend/resources/
        fi

        # Copy model files
        if [ -d "pii_onnx_model" ]; then
          cp -r pii_onnx_model frontend/resources/
        fi

    - name: Package Electron app (DMG)
      working-directory: frontend
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: false  # Disable code signing
      run: npm run electron:pack

    - name: Ad-hoc sign app and rebuild DMG
      working-directory: frontend
      run: |
        # Ad-hoc sign the app (no certificate needed) and rebuild DMG
        # This helps macOS accept the app even without proper code signing
        DMG_PATH=$(find release -name "*.dmg" | head -1)
        if [ -n "$DMG_PATH" ]; then
          echo "Processing DMG: $DMG_PATH"

          # Create temporary directories
          TEMP_DIR=$(mktemp -d)
          MOUNT_POINT="$TEMP_DIR/mount"
          EXTRACT_DIR="$TEMP_DIR/extract"
          mkdir -p "$MOUNT_POINT" "$EXTRACT_DIR"

          # Mount the DMG
          hdiutil attach "$DMG_PATH" -mountpoint "$MOUNT_POINT" -quiet -readonly

          # Copy contents to extract directory
          cp -R "$MOUNT_POINT"/* "$EXTRACT_DIR/"

          # Unmount the DMG
          hdiutil detach "$MOUNT_POINT" -quiet

          # Find and process the app bundle
          APP_PATH=$(find "$EXTRACT_DIR" -name "*.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            echo "Processing app: $APP_PATH"

            # Remove quarantine attribute
            xattr -cr "$APP_PATH"
            find "$APP_PATH" -type f -exec xattr -c {} \; 2>/dev/null || true

            # Ad-hoc sign the app bundle (this helps macOS accept it)
            # Ad-hoc signing uses "-" which means "sign with ad-hoc identity"
            codesign --force --deep --sign - "$APP_PATH" 2>&1 || {
              echo "âš ï¸  Ad-hoc signing failed, continuing anyway..."
            }

            # Verify the signing
            codesign --verify --verbose "$APP_PATH" 2>&1 || echo "âš ï¸  Code signing verification failed (expected for ad-hoc)"

            echo "âœ… App processed and ad-hoc signed"

            # Get DMG metadata
            DMG_NAME=$(basename "$DMG_PATH" .dmg)
            DMG_DIR=$(dirname "$DMG_PATH")

            # Remove old DMG
            rm -f "$DMG_PATH"

            # Create new DMG
            hdiutil create -volname "$DMG_NAME" -srcfolder "$EXTRACT_DIR" -ov -format UDZO "$DMG_DIR/$DMG_NAME.dmg"

            echo "âœ… DMG rebuilt with ad-hoc signed app"
          else
            echo "âš ï¸  App bundle not found in DMG"
          fi

          # Cleanup
          rm -rf "$TEMP_DIR"
        else
          echo "âš ï¸  DMG not found, skipping processing"
        fi

    - name: Upload DMG artifact
      uses: actions/upload-artifact@v4
      with:
        name: Privacy-Proxy-DMG
        path: frontend/release/*.dmg
        retention-days: 30

    - name: Upload ZIP artifact
      uses: actions/upload-artifact@v4
      with:
        name: Privacy-Proxy-ZIP
        path: frontend/release/*.zip
        retention-days: 30
      continue-on-error: true # ZIP might not always be created

    - name: Build summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… DMG files created:" >> $GITHUB_STEP_SUMMARY
        ls -lh frontend/release/*.dmg 2>/dev/null | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY || echo "- No DMG files found" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ Artifacts uploaded to workflow run" >> $GITHUB_STEP_SUMMARY

    - name: Get version
      id: get_version
      working-directory: frontend
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Create Release
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.version }}-${{ github.run_number }}
        name: Release v${{ steps.get_version.outputs.version }}-${{ github.run_number }}
        body: |
          ## Privacy Proxy v${{ steps.get_version.outputs.version }}

          Automated build from commit ${{ github.sha }}

          ### Changes
          - See commit history for details

          ### Downloads
          - DMG installer for macOS
          - ZIP archive

          ### Installation Notes

          If you see a "Privacy Proxy is damaged" error when opening the app:

          1. **Right-click method**: Right-click the app in Finder â†’ Select "Open" â†’ Click "Open" in the dialog

          2. **Terminal method**: Open Terminal and run:
             ```bash
             xattr -cr /Applications/Privacy\ Proxy.app
             ```

          This is required because the app is not code-signed with an Apple Developer certificate. The app is safe to use.
        files: |
          frontend/release/*.dmg
          frontend/release/*.zip
        draft: false
        prerelease: ${{ github.ref != 'refs/heads/main' }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

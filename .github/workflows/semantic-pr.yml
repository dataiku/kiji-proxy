name: Semantic PR Title

on:
  pull_request_target:
    types: [opened, edited, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  lint-title:
    name: Validate PR title
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: amannn/action-semantic-pull-request@e32d7e603df1aa1ba07e981f2a23455dee596825 # v5
        id: lint_pr_title
        with:
          types: |
            feat
            fix
            docs
            style
            chore
            refactor
            test
            ci
            perf
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: "Subject must not start with an uppercase letter"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Read commit guide
        if: always() && (steps.lint_pr_title.outputs.error_message != null)
        id: guide
        run: |
          {
            echo "content<<GUIDE_EOF"
            cat .github/semantic-commit-guide.md
            echo "GUIDE_EOF"
          } >> "$GITHUB_OUTPUT"

      - uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2
        if: always() && (steps.lint_pr_title.outputs.error_message != null)
        with:
          header: pr-title-lint-error
          message: |
            > [!WARNING]
            > **PR title does not follow the Conventional Commits specification.**

            ${{ steps.lint_pr_title.outputs.error_message }}

            ---

            ${{ steps.guide.outputs.content }}

      - uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2
        if: ${{ steps.lint_pr_title.outputs.error_message == null }}
        with:
          header: pr-title-lint-error
          delete: true

  check-scope:
    name: Check PR scope
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Classify changed files
        id: classify
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: bash .github/scripts/classify-pr-files.sh

      - uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2
        if: steps.classify.outputs.mixed == 'true'
        with:
          header: pr-scope-warning
          message: |
            > [!WARNING]
            > **This PR touches 3+ distinct areas of the codebase.**
            >
            > Consider splitting into smaller, focused PRs â€” each covering a single semantic type.
            > This makes reviews easier and keeps the git history clean.

            ${{ steps.classify.outputs.details }}

      - uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2
        if: steps.classify.outputs.mixed == 'false'
        with:
          header: pr-scope-warning
          delete: true

      - name: Fail if mixed
        if: steps.classify.outputs.mixed == 'true'
        run: |
          echo "::error::PR touches 3+ distinct areas (ci, docs, code, test, chore). Consider splitting into focused PRs."
          exit 1

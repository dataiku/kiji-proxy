name: Changesets Release

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Create Release PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            src/frontend/package-lock.json

      - name: Check for changesets
        id: check_changesets
        run: |
          if ls .changeset/*.md 1> /dev/null 2>&1; then
            # Exclude README.md from the count
            count=$(ls .changeset/*.md 2>/dev/null | grep -v "README.md" | wc -l)
            if [ "$count" -gt 0 ]; then
              echo "has_changesets=true" >> $GITHUB_OUTPUT
              echo "Found $count changeset(s)"
            else
              echo "has_changesets=false" >> $GITHUB_OUTPUT
              echo "No changesets found (only README.md exists)"
            fi
          else
            echo "has_changesets=false" >> $GITHUB_OUTPUT
            echo "No changesets found"
          fi

      - name: Install Dependencies
        if: steps.check_changesets.outputs.has_changesets == 'true'
        run: |
          # Install root dependencies (includes @changesets/cli)
          npm install

          # Install workspace dependencies
          npm install --workspace=src/frontend

      - name: Create Version PR
        if: steps.check_changesets.outputs.has_changesets == 'true'
        id: changesets
        run: |
          # Run changeset version from root (where .changeset folder is)
          # It will update src/frontend/package.json based on workspace config
          npx changeset version

          # Sync root package.json version with frontend
          NEW_VERSION=$(node -p "require('./src/frontend/package.json').version")
          npm version "$NEW_VERSION" --no-git-tag-version
          echo "Synced root package.json to $NEW_VERSION"

          # Sync pyproject.toml version
          if [ -f "pyproject.toml" ]; then
            sed -i "s/^version = \"[0-9.]*\"/version = \"${NEW_VERSION}\"/" pyproject.toml
            echo "Synced pyproject.toml to $NEW_VERSION"
          fi

          # Sync .vscode/launch.json dev version
          if [ -f ".vscode/launch.json" ]; then
            sed -i "s/main.version=[0-9.]*-dev/main.version=${NEW_VERSION}-dev/" .vscode/launch.json
            echo "Synced .vscode/launch.json to ${NEW_VERSION}-dev"
          fi

          # Check if there are changes
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes were made by changesets"
          fi

      - name: Create Pull Request
        if: steps.changesets.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create and checkout new branch
          BRANCH_NAME="changeset-release/main"
          git checkout -b "$BRANCH_NAME"

          # Commit changes
          git add .
          git commit -m "chore: version packages"

          # Push branch
          git push -f origin "$BRANCH_NAME"

          # Create PR body
          PR_BODY="This PR was automatically generated by the Changesets workflow.

          Merging this PR will:
          - Update package versions in \`src/frontend/package.json\`, root \`package.json\`, and \`pyproject.toml\`
          - Update \`CHANGELOG.md\` with the changes
          - Update \`.vscode/launch.json\` dev version

          Once merged, a release tag (\`v${{ steps.changesets.outputs.version }}\`) will be created automatically, triggering the DMG and Linux release builds."

          # Create PR using GitHub CLI
          gh pr create \
            --title "chore: version packages" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME" \
            --label release \
            || echo "PR may already exist"

      - name: No changesets found
        if: steps.check_changesets.outputs.has_changesets != 'true'
        run: |
          echo "No changesets found - skipping version PR creation"
          echo "This is normal if no changes requiring a release were made."
